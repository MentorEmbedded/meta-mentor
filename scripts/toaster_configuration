#!/bin/sh
#
# Copyright 2015-2016 Mentor Graphics Corporation
#
# This file is licensed under the terms of the GNU General Public License
# version 2.  This program  is licensed "as is" without any warranty of any
# kind, whether express or implied.

echo "Creating toaster configuration"

BUILDDIR="$1"
MELDIR="$2"
BITBAKEDIR="$3"
CMD_LINE="$4"

create_custom_xml() {
    "$MELDIR"/meta-mentor/scripts/toaster-layers-recipes-config.py "$BUILDDIR" "$MELDIR" "$CMD_LINE"
}

create_toaster_venv () {
    if [ -f /etc/redhat-release ]; then
        # If its RHEL 7 there is a bug in virtualenv which has to be tweaked
        if [ $(cat /etc/redhat-release  | awk {'print $7'} | cut -d "." -f1) -eq 7 ]; then
            easy_install --user --upgrade virtualenv
        fi
    fi
    python -m virtualenv -p python3 "$BUILDDIR/venv"
    python -m virtualenv -p python2 "$BUILDDIR/venv"
    (
        . "$BUILDDIR/venv/bin/activate"
        pip3 install -r "$BITBAKEDIR/toaster-requirements.txt"
    )
}

create_toaster_setupscript() {
   cat <<EOF > "$BUILDDIR"/toaster-setup-environment
if [ "\$#" -ne 1 ]; then
    echo >&2 "Usage: . ./toaster-setup-environment {start|stop}"
else
  if [ "\$1" == "start" ]; then
    . $BUILDDIR/venv/bin/activate
    . $BITBAKEDIR/bin/toaster start
    xdg-open "http://localhost:8000"
  elif [ "\$1" == "stop" ]; then
    . $BITBAKEDIR/bin/toaster stop
    deactivate
  else
     echo >&2 "Usage: . ./toaster-setup-environment {start|stop}"
  fi
fi

EOF
}

create_custom_xml
if [ ! -e "$BUILDDIR/venv/bin/python2" ] || [ ! -e "$BUILDDIR/venv/bin/python3" ]; then
    rm -f "$BUILDDIR/venv/bin/python"*
    create_toaster_venv
fi
create_toaster_setupscript

echo >&2 "Toaster configuration created, source $BUILDDIR/toaster-setup-environment to start toaster"
