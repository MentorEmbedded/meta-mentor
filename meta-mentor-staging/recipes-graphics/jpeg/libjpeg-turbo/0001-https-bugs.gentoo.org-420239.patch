From bbfb97b15f5e40e8565120e79eebe492a84ba853 Mon Sep 17 00:00:00 2001
From: Christopher Larson <chris_larson@mentor.com>
Date: Thu, 17 Nov 2016 20:42:36 -0700
Subject: [PATCH] https://bugs.gentoo.org/420239

https://sourceforge.net/tracker/?func=detail&aid=3533795&group_id=303195&atid=1278160
---
 acinclude.m4    | 7 ++++++-
 configure       | 7 ++++++-
 simd/nasm_lt.sh | 2 +-
 3 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/acinclude.m4 b/acinclude.m4
index 2c90762..57dc4ce 100644
--- a/acinclude.m4
+++ b/acinclude.m4
@@ -36,7 +36,11 @@ case "$host_os" in
   linux*)
     case "$host_cpu" in
       x86_64)
-        objfmt='ELF64'
+        if echo __ILP32__ | $CC $CFLAGS -E - | grep __ILP32__ > /dev/null; then
+          objfmt='ELF64'
+        else
+          objfmt='ELFX32'
+        fi
         ;;
       *)
         objfmt='ELF'
@@ -97,6 +101,7 @@ case "$objfmt" in
   a.out)      NAFLAGS='-faout -DAOUT';;
   BSD-a.out)  NAFLAGS='-faoutb -DAOUT';;
   ELF)        NAFLAGS='-felf -DELF';;
+  ELFX32)     NAFLAGS='-felfx32 -DELF -D__x86_64__';;
   ELF64)      NAFLAGS='-felf64 -DELF -D__x86_64__';;
   RDF)        NAFLAGS='-frdf -DRDF';;
   Mach-O)     NAFLAGS='-fmacho -DMACHO';;
diff --git a/configure b/configure
index fd6bdaa..dfacd86 100755
--- a/configure
+++ b/configure
@@ -14869,7 +14869,11 @@ case "$host_os" in
   linux*)
     case "$host_cpu" in
       x86_64)
-        objfmt='ELF64'
+        if echo __ILP32__ | $CC $CFLAGS -E - | grep __ILP32__ > /dev/null; then
+          objfmt='ELF64'
+        else
+          objfmt='ELFX32'
+        fi
         ;;
       *)
         objfmt='ELF'
@@ -14933,6 +14937,7 @@ case "$objfmt" in
   a.out)      NAFLAGS='-faout -DAOUT';;
   BSD-a.out)  NAFLAGS='-faoutb -DAOUT';;
   ELF)        NAFLAGS='-felf -DELF';;
+  ELFX32)     NAFLAGS='-felfx32 -DELF -D__x86_64__';;
   ELF64)      NAFLAGS='-felf64 -DELF -D__x86_64__';;
   RDF)        NAFLAGS='-frdf -DRDF';;
   Mach-O)     NAFLAGS='-fmacho -DMACHO';;
diff --git a/simd/nasm_lt.sh b/simd/nasm_lt.sh
index 817be16..7f2df88 100755
--- a/simd/nasm_lt.sh
+++ b/simd/nasm_lt.sh
@@ -14,7 +14,7 @@ while [ $# -gt 0 ]; do
                 pic=yes
             fi
             ;;
-        -f|-fbin|-faout|-faoutb|-fcoff|-felf|-felf64|-fas86| \
+        -f|-fbin|-faout|-faoutb|-fcoff|-felf|-felf64|-felfx32|-fas86| \
         -fobj|-fwin32|-fwin64|-frdf|-fieee|-fmacho|-fmacho64)
             # it's a file format specifier for nasm.
             command="$command $1"
-- 
2.8.0

